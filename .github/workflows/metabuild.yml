name: Metanthropes Automated Build & Release
on: push
jobs:
  build:
    name: Metanthropes Automated Build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the master branch
      uses: actions/checkout@v3
    - name: Install NPM dependencies
      run: npm install
    - name: Compile SCSS with gulp
      run: npm run compile
    - name: Upload the compiled files
      uses: actions/upload-artifact@v3
      with:
        name: compiledcss
        path: ./
    - name: Get System ID
      id: systemID
      uses: notiz-dev/github-action-json-property@release
      with: 
        path: 'system.json'
        prop_path: 'id'
    - name: Get Version Number
      id: version
      uses: notiz-dev/github-action-json-property@release
      with: 
        path: 'system.json'
        prop_path: 'version'
  release:
    name: Metanthropes Automated Release
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Download the compiled files
      uses: actions/download-artifact@v3
      with:
        name: compiledcss
    - name: Test Artifact download
      run: ls -R
    - name: Zip the compiled files
      uses: thedoctor0/zip-release@0.7.2
      with:
        type: 'zip'
        filename: '${{steps.id.output.props}}.zip' # I need to make the name to match the release name / version name of the build
        exclusions: '*.git* /*node_modules/* /*.vscode/* /*.npmignore/* /*.nvmrc/* /gulpfile.js/* /package-lock.json/* /package.json/* /scss/*'
    - name: Get tag    
      id: tag
      uses: dawidd6/action-get-tag@v1.1.0
    - name: Set Download Link
      uses: jossef/action-set-json-field@v2
      with:
        file: './system.json'
        field: 'download'
        value: "https://github.com/${{github.repository}}/releases/download/${{steps.tag.outputs.tag}}/${{steps.systemID.outputs.prop}}.zip"
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
          files: |
          ${{steps.id.output.props}}.zip
          system.json
        tag_name: ${{steps.version.output.props}}
        name: ${{steps.id.output.props}} - Version ${{steps.version.output.props}}
        body: ${{ github.event.release.body }}
        draft: true
        prerelease: false